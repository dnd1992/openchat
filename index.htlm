<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Open Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { background:#0f1115; color:#e6e7eb; font-family:sans-serif; margin:0; }
  .wrap { max-width:900px; margin:20px auto; padding:10px; }
  .card { background:#151821; border-radius:10px; padding:15px; }
  .btn { background:#6ac1ff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:bold; }
  .btn.secondary { background:none; border:1px solid #2a3142; color:#e6e7eb; }
  .field { background:#0e121a; border:1px solid #2a3142; border-radius:6px; padding:8px; color:#e6e7eb; width:100%; }
  .messages { height:300px; overflow-y:auto; background:#0b0f16; border:1px solid #2a3142; border-radius:6px; padding:8px; }
  .msg { margin-bottom:8px; padding:6px; border-radius:6px; background:#121826; }
  .me { background:#11202a; }
  .meta { font-size:12px; color:#9aa0aa; margin-bottom:4px; }
  .chat { display:flex; gap:6px; margin-top:6px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2>Open Chat</h2>
    <button id="createRoomBtn" class="btn">Create new room</button>
    <div id="landing"><p>No room selected. Click "Create new room" or open a shared link.</p></div>
    <div id="roomPanel" style="display:none;">
      <p>Room: <span id="roomIdLabel"></span></p>
      <input id="shareLink" class="field" readonly />
      <button id="copyBtn" class="btn secondary">Copy link</button>
      <p>Your name:</p>
      <input id="nameInput" class="field" placeholder="Your name" />
      <button id="saveNameBtn" class="btn secondary">Save name</button>
      <div class="messages" id="messages"></div>
      <form id="form" class="chat">
        <input id="messageInput" class="field" placeholder="Type a message" />
        <button class="btn" type="submit">Send</button>
      </form>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

<script>
// === Your Firebase config ===
const firebaseConfig = {
  apiKey: "AIzaSyDfRpS-kZZ_ZMBSMqoBWtZkiF6i7Tywgic",
  authDomain: "open-chat-b32f8.firebaseapp.com",
  databaseURL: "https://open-chat-b32f8-default-rtdb.firebaseio.com",
  projectId: "open-chat-b32f8",
  storageBucket: "open-chat-b32f8.firebasestorage.app",
  messagingSenderId: "394592074242",
  appId: "1:394592074242:web:d3eb4f3c5211df96bfc51b",
  measurementId: "G-7M53FN6BD1"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const landing = document.getElementById('landing');
const roomPanel = document.getElementById('roomPanel');
const roomIdLabel = document.getElementById('roomIdLabel');
const shareLink = document.getElementById('shareLink');
const copyBtn = document.getElementById('copyBtn');
const createRoomBtn = document.getElementById('createRoomBtn');
const nameInput = document.getElementById('nameInput');
const saveNameBtn = document.getElementById('saveNameBtn');
const form = document.getElementById('form');
const messageInput = document.getElementById('messageInput');
const messagesEl = document.getElementById('messages');

let currentRoom = null;
let messagesRef = null;
let user = null;

function getParam(name) {
  return new URL(window.location.href).searchParams.get(name);
}
function setParam(name, value) {
  const url = new URL(window.location.href);
  url.searchParams.set(name, value);
  return url.toString();
}
function randomId(len=8) {
  const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
  return Array.from(crypto.getRandomValues(new Uint8Array(len)), b => chars[b % chars.length]).join('');
}
function scrollToBottom() {
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
function renderMessage(msg, isMe) {
  const div = document.createElement('div');
  div.className = 'msg' + (isMe ? ' me' : '');
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = (msg.name || 'Anon') + ' â€¢ ' + new Date(msg.ts).toLocaleString();
  const text = document.createElement('div');
  text.textContent = msg.text || '';
  div.append(meta, text);
  messagesEl.appendChild(div);
}
function updateShareUI(roomId) {
  const url = new URL(window.location.href);
  url.searchParams.set('room', roomId);
  shareLink.value = url.toString();
  roomIdLabel.textContent = roomId;
}
function loadName() {
  const saved = localStorage.getItem('darkchat:name');
  if (saved) nameInput.value = saved;
}
function saveName() {
  const val = nameInput.value.trim().slice(0,40) || 'Anon';
  localStorage.setItem('darkchat:name', val);
  nameInput.value = val;
}

auth.signInAnonymously().then(cred => {
  user = cred.user;
  boot();
});

function boot() {
  loadName();
  const room = getParam('room');
  if (room) joinRoom(room);
}

function joinRoom(roomId) {
  landing.style.display = 'none';
  roomPanel.style.display = '';
  currentRoom = roomId;
  updateShareUI(roomId);
  messagesEl.innerHTML = '';
  if (messagesRef) messagesRef.off();
  messagesRef = db.ref('rooms/' + roomId + '/messages');
  messagesRef.on('child_added', snap => {
    const msg = snap.val() || {};
    const isMe = msg.uid && user && msg.uid === user.uid;
    renderMessage(msg, isMe);
    scrollToBottom();
  });
}

createRoomBtn.onclick = () => {
  const id
